下面這份表格就是根據你現有的系統（包含 Payuni、GAS、Google OAuth）
**目前該補強的安全層級整理版**，
重點、原因、以及該怎麼處理都幫你壓成實務對照。

---

### ✅ 系統安全加強重點整理

| 編號    | 項目                | 防禦類型     | 防止攻擊                                       | 成效    | 調整建議                                                                                                      |
| ----- | ----------------- | -------- | ------------------------------------------ | ----- | --------------------------------------------------------------------------------------------------------- |
| **A** | **Webhook 重放防禦**  | 後端邏輯防護   | 防止重複通知、重放攻擊（攻擊者重送合法封包造成重複記帳或重複更新）          | ⭐⭐⭐⭐  | 在 `/payuni-webhook` 加上交易防重檢查：比對 `TradeNo + Email + PayTime` 是否已存在，若重複則直接忽略，不需再處理。這樣就算伺服器重啟或延遲通知，也能保持一致安全。 |
| **C** | **HTTPS 強制化**     | 傳輸層安全    | 防止中間人竊聽、Session Cookie 被截取、表單明文傳輸          | ⭐⭐⭐⭐⭐ | 將伺服器設定為只接受 HTTPS（用 `app.enable("trust proxy")` + redirect middleware），同時將 Cookie `secure` 屬性設為 `true`。    |
| **D** | **Session 固定化防禦** | 登入流程防禦   | 防止攻擊者在登入前預先植入 session 並竊取登入後 session ID    | ⭐⭐⭐⭐  | 登入成功（Google OAuth callback）後，**重新生成 session ID**：`req.session.regenerate()`，然後再寫入使用者資訊。                   |
| **E** | **Nonce 機制**      | API 安全強化 | 防止重複送單、機器人自動化攻擊（重複 POST `/create-payment`） | ⭐⭐⭐   | 在建立付款時產生一次性 Nonce，儲存於伺服器端 Map 或 DB，使用後即失效；若同一帳號、同一商品重複送出，直接擋下。                                            |
| **F** | **GAS 簽章驗證**      | 伺服器間認證   | 防止偽造 Webhook、假冒 GAS 請求寫入訂單                 | ⭐⭐⭐⭐⭐ | 在 GAS 端用 HMAC-SHA256 對 payload 產生簽章（用共用密鑰），Node.js 端驗證 `signature` header 是否匹配，替代目前僅依賴 cookie token 的方式。  |

---

### 💡 總結一句話：

你整體的防禦已經有**70~80%安全性**，但這 5 點是「真的能被打」的面，
其中優先級建議如下：

1. **C → 先上 HTTPS**（傳輸層沒鎖住＝其他都白搭）
2. **A → 做 webhook 防重判斷**（這是實際會出問題的點）
3. **F → 改簽章驗證**（GAS 與你之間必須有伺服器級驗證）
4. **D → session 固定防禦**
5. **E → nonce 防重送單**（屬強化層，不是必須但推薦）
