# 安全性深度解析 (Security Deep Dive)

歡迎來到「金流整合實戰包」的安全性核心。線上交易的基礎是信任，而信任來自於強大的安全機制。本文件將深入探討此專案中為您內建的各項安全機制，讓您不僅知道「如何使用」，更理解「為何如此設計」。

我們採用了「深度防禦 (Defense in Depth)」策略，透過多層次的防護，即使某一層被繞過，其他層依然能保護您的應用程式與使用者資料。

---

## 1. Helmet - 您的第一道 HTTP 防線

**是什麼？**
`Helmet` 是一個 Express 中介軟體，它本身是 15 個小型中介軟體的集合，專門用來設定與安全性相關的 HTTP 標頭 (HTTP Headers)。

**為什麼重要？**
許多常見的 Web 攻擊，如跨站腳本攻擊 (XSS)、點擊劫持 (Clickjacking)，都可以透過正確設定 HTTP 標頭來防範。Helmet 為您自動處理了這些繁瑣但至關重要的設定。

**在此專案中，Helmet 為您做了什麼？**
- **`Strict-Transport-Security`**: 強制瀏覽器只能使用 HTTPS 與您的伺服器通訊，杜絕中間人攻擊。
- **`X-Content-Type-Options`**: 防止瀏覽器「猜測」檔案類型，避免惡意檔案被當作可執行腳本。
- **`X-Frame-Options`**: 防止您的網頁被嵌入到 `<iframe>` 中，防禦點擊劫持攻擊。
- **`Content-Security-Policy`**: (可選，但功能強大) 能精確定義允許載入哪些來源的腳本、樣式、圖片等，是防禦 XSS 的利器。
- ...以及其他多項標頭設定。

> **簡單來說，Helmet 就像是為您的網站聘請了一位全天候的保全，檢查所有進出的網路請求，確保它們符合安全規範。**

---

## 2. CORS (跨來源資源共用) - 精準控制 API 存取

**是什麼？**
CORS 是一種瀏覽器安全機制，它限制了網頁只能請求與自己「同來源」(Same-Origin) 的資源。當您需要從 `your-domain.com` 的前端去請求 `api.your-domain.com` 的後端時，就需要 CORS 規則來「放行」。

**在此專案中，我們如何設定？**
在 `index.js` 中，我們使用 `cors` 中介軟體，並設定只允許來自您在 `.env` 檔案中指定的 `DOMAIN` 的請求。

**為什麼這很重要？**
如果沒有正確設定，任何惡意網站都可以透過其前端 JavaScript，向您的後端 API 發起請求（例如，嘗試代表已登入的使用者下訂單）。我們的設定確保了只有您自己的網站前端，才有權限與您的後端伺服器溝通。

---

## 3. CSRF (跨站請求偽造) - 保護使用者操作的真實性

**是什麼？**
CSRF 是一種常見的攻擊，攻擊者在自己的網站上放置一個陷阱（例如，一張看不見的圖片或一個表單），誘騙已在您網站登入的使用者點擊。一旦點擊，使用者的瀏覽器就會在不知情的情況下，向您的伺服器發送一個惡意請求（例如，更改密碼、下訂單）。

**在此專案中，我們如何防禦？**
我們採用了 `csurf` (或類似的 Token-Based 機制)。
1.  當使用者載入您的頁面時，伺服器會產生一個獨一無二、不可預測的 `CSRF Token`。
2.  前端在發起任何會改變狀態的請求（如 `POST` 請求去建立訂單）時，必須在請求中附上這個 Token。
3.  後端在收到請求時，會驗證這個 Token 是否匹配。如果 Token 不存在或不正確，請求將被拒絕。

**為什麼這很重要？**
由於惡意網站無法得知這個獨一無二的 Token，因此它無法偽造出一個能通過驗證的請求。這確保了每一個重要操作，都是由使用者在您的網站上親自發起的。

---

## 4. Session 安全管理 - 保護使用者的登入狀態

**是什麼？**
我們使用 `express-session` 來管理使用者登入後的狀態。但僅僅能用是不夠的，安全的設定至關重要。

**我們的安全設定：**
- **`secret: process.env.SESSION_SECRET`**: 用於簽名 Session ID Cookie 的密鑰。一個長且隨機的密鑰可以防止攻擊者偽造 Session。這就是為什麼我們一再強調 `SESSION_SECRET` 的重要性。
- **`cookie.httpOnly: true`**: 此設定禁止客戶端的 JavaScript 存取 Session Cookie。這能有效防禦 XSS 攻擊者竊取使用者的 Session。
- **`cookie.secure: true`** (在正式環境中): 此設定確保 Session Cookie 只在 HTTPS 連線下被傳輸，防止在不安全的 HTTP 連線中被竊聽。
- **`cookie.sameSite: 'strict'`**: 這是防禦 CSRF 的另一道重要防線，它告訴瀏覽器完全不要在跨站請求中發送此 Cookie。

---

## 5. AES-256-GCM 加密 (`utils/crypto.js`) - 保護您的敏感資料

**是什麼？**
AES 是當今最安全的對稱加密標準之一。`256` 代表其金鑰長度，強度極高。而 `GCM` (Galois/Counter Mode) 模式則更進一步，它在加密的同時加入了「身份驗證」，確保資料在傳輸過程中不僅未被竊聽，也未被篡改。

**您可以用它來做什麼？**
`utils/crypto.js` 中為您封裝了易於使用的 `encrypt` 和 `decrypt` 函式。您可以利用它們來：
- 在將資料發送到第三方服務（如 Payuni）前，對部分敏感欄位進行加密。
- 在資料庫中儲存某些敏感資訊（例如 API 金鑰）時，對其進行加密儲存。
- 保護 Webhook 傳輸的資料。

> **這就像是為您的核心資料提供了一個無法破解的保險箱，並在每次開鎖時都驗證指紋，確保其完整性。**

---

### 結論

安全不是單一功能，而是一個體系。透過 Helmet、CORS、CSRF、安全的 Session 管理以及強大的加密工具，本實戰包為您建立了一個穩固的安全地基。理解這些機制，將使您在未來的開發中，更有能力保護您的資產與使用者。