# Google Sheets API ç›´æ¥é›†æˆæŒ‡å—

æœ¬æŒ‡å—å°‡å¸¶æ‚¨è¨­å®šåœ¨ Node.js å°ˆæ¡ˆä¸­ç›´æ¥ä½¿ç”¨ Google Sheets APIï¼ˆä¸é€é Google Apps Scriptï¼‰ã€‚

## å„ªå‹¢

âœ… **ç›´æ¥æ§åˆ¶**ï¼šåœ¨å¾Œç«¯ç¨‹å¼ç¢¼ä¸­ç›´æ¥æ“ä½œ Google Sheetsï¼Œç„¡éœ€é€é GAS Webhook
âœ… **æ›´å¥½çš„éŒ¯èª¤è™•ç†**ï¼šåŒæ­¥éŒ¯èª¤è™•ç†ï¼Œæ›´å®¹æ˜“é™¤éŒ¯
âœ… **æ›´å¿«çš„éŸ¿æ‡‰**ï¼šç„¡éœ€ç­‰å¾… GAS ä¼ºæœå™¨çš„è¿´åœˆ
âœ… **æ›´éˆæ´»çš„æ“ä½œ**ï¼šå¯ä½¿ç”¨ Google Sheets API çš„å…¨éƒ¨åŠŸèƒ½

---

## ç¬¬ 1 æ­¥ï¼šå»ºç«‹ Google Sheets

1. å‰å¾€ [Google Sheets](https://sheets.google.com/)ï¼Œå»ºç«‹ä¸€ä»½æ–°çš„ç©ºç™½è©¦ç®—è¡¨
2. å°‡å…¶å‘½åç‚ºã€Œé‡‘æµå°ˆæ¡ˆè¨‚å–®ç´€éŒ„ã€ï¼ˆæˆ–ä»»ä½•æ‚¨åå¥½çš„åç¨±ï¼‰
3. **è¤‡è£½è©¦ç®—è¡¨ ID**ï¼šç€è¦½å™¨ URL æ ¼å¼ç‚ºï¼š
   ```
   https://docs.google.com/spreadsheets/d/[SHEET_ID]/edit
   ```
   è¤‡è£½ `d/` å’Œ `/edit` ä¹‹é–“çš„å…§å®¹ï¼Œé€™å°±æ˜¯æ‚¨çš„ **GOOGLE_SHEETS_ID**

---

## ç¬¬ 2 æ­¥ï¼šå»ºç«‹ Google Cloud æœå‹™å¸³æˆ¶

### 2.1 å»ºç«‹ Google Cloud å°ˆæ¡ˆ

1. å‰å¾€ [Google Cloud Console](https://console.cloud.google.com/)
2. é»æ“Šé ‚éƒ¨çš„å°ˆæ¡ˆä¸‹æ‹‰é¸å–®ï¼Œé¸æ“‡ã€Œæ–°å»ºå°ˆæ¡ˆã€
3. è¼¸å…¥å°ˆæ¡ˆåç¨±ï¼ˆä¾‹å¦‚ã€Œé‡‘æµç³»çµ±ã€ï¼‰ï¼Œé»æ“Šã€Œå»ºç«‹ã€
4. ç­‰å¾…å°ˆæ¡ˆå»ºç«‹å®Œæˆ

### 2.2 å•Ÿç”¨ Google Sheets API

1. åœ¨ Google Cloud Console ä¸­ï¼Œé¸æ“‡æ‚¨å‰›å»ºç«‹çš„å°ˆæ¡ˆ
2. é»æ“Šå·¦å´èœå–®çš„ã€ŒAPI å’Œæœå‹™ã€ > ã€ŒAPI åº«ã€
3. æœå°‹ã€ŒGoogle Sheets APIã€
4. é»æ“Šã€ŒGoogle Sheets APIã€ï¼Œç„¶å¾Œé»æ“Šè—è‰²çš„ã€Œå•Ÿç”¨ã€æŒ‰éˆ•
5. ç­‰å¾… API å•Ÿç”¨å®Œæˆ

### 2.3 å»ºç«‹æœå‹™å¸³æˆ¶

1. åœ¨ Google Cloud Console ä¸­ï¼Œé»æ“Šå·¦å´èœå–®çš„ã€ŒAPI å’Œæœå‹™ã€ > ã€Œèªè­‰ã€
2. é»æ“Šã€Œå»ºç«‹èªè­‰ã€ > ã€Œæœå‹™å¸³æˆ¶ã€
3. å¡«å¯«ä»¥ä¸‹è³‡è¨Šï¼š
   - **æœå‹™å¸³æˆ¶åç¨±**ï¼šä¾‹å¦‚ã€Œé‡‘æµ-APIã€
   - **æœå‹™å¸³æˆ¶ ID**ï¼šè‡ªå‹•ç”¢ç”Ÿ
   - **æè¿°**ï¼šå¯é¸ï¼Œä¾‹å¦‚ã€Œç”¨æ–¼ Node.js å¾Œç«¯çš„ Google Sheets å­˜å–ã€
4. é»æ“Šã€Œå»ºç«‹ä¸¦ç¹¼çºŒã€
5. åœ¨ã€Œæˆäºˆæ­¤æœå‹™å¸³æˆ¶å­˜å–å°ˆæ¡ˆçš„æ¬Šé™ã€æ­¥é©Ÿä¸­ï¼Œå¯ä»¥ç•¥éï¼ˆé»æ“Šã€Œç¹¼çºŒã€ï¼‰
6. åœ¨ã€Œæˆäºˆä½¿ç”¨è€…å­˜å–æ­¤æœå‹™å¸³æˆ¶çš„æ¬Šé™ã€æ­¥é©Ÿä¸­ï¼Œä¹Ÿå¯ä»¥ç•¥éï¼ˆé»æ“Šã€Œå®Œæˆã€ï¼‰

### 2.4 å»ºç«‹ä¸¦ä¸‹è¼‰é‡‘é‘°

1. åœ¨ã€ŒAPI å’Œæœå‹™ã€ > ã€Œèªè­‰ã€é é¢ä¸­ï¼Œå°‹æ‰¾æ‚¨å‰›å»ºç«‹çš„æœå‹™å¸³æˆ¶ï¼Œé»æ“Šå®ƒ
2. è½‰åˆ°ã€Œé‡‘é‘°ã€æ¨™ç±¤é 
3. é»æ“Šã€Œæ–°å¢é‡‘é‘°ã€ > ã€Œå»ºç«‹æ–°é‡‘é‘°ã€
4. é¸æ“‡ **JSON** æ ¼å¼
5. é»æ“Šã€Œå»ºç«‹ã€ï¼Œç³»çµ±æœƒè‡ªå‹•ä¸‹è¼‰ä¸€å€‹ JSON æª”æ¡ˆ
6. **å¦¥å–„ä¿ç®¡æ­¤æª”æ¡ˆ**ï¼Œé€™æ˜¯æ‚¨çš„æœå‹™å¸³æˆ¶èªè­‰é‡‘é‘°

---

## ç¬¬ 3 æ­¥ï¼šé…ç½® Node.js å°ˆæ¡ˆ

### 3.1 è¤‡è£½é‡‘é‘°æ–‡ä»¶åˆ°å°ˆæ¡ˆ

1. å°‡å¾ Google Cloud ä¸‹è¼‰çš„ JSON é‡‘é‘°æ–‡ä»¶è¤‡è£½åˆ°å°ˆæ¡ˆæ ¹ç›®éŒ„
2. å°‡å…¶é‡å‘½åç‚º `google-key.json`ï¼ˆæˆ–æ‚¨å–œæ­¡çš„åç¨±ï¼‰
3. **é‡è¦ï¼šè«‹å°‡æ­¤æ–‡ä»¶æ·»åŠ åˆ° `.gitignore`ï¼Œé¿å…æ´©éœ²**ï¼š

```gitignore
# Google Sheets API
google-key.json
```

### 3.2 æ›´æ–° .env æ–‡ä»¶

åœ¨æ‚¨çš„ `.env` æª”æ¡ˆä¸­æ·»åŠ ä»¥ä¸‹ç’°å¢ƒè®Šæ•¸ï¼ˆç§»é™¤ GAS ç›¸é—œçš„è®Šæ•¸ï¼‰ï¼š

```env
# ç¾æœ‰è®Šæ•¸...
PAYUNI_API_URL=...
PAYUNI_MERCHANT_ID=...
# ... å…¶ä»–ç¾æœ‰è®Šæ•¸ ...

# Google Sheets API é…ç½®
GOOGLE_SHEETS_ID=ç²˜è²¼_æ‚¨çš„_SHEET_ID_åˆ°_é€™è£¡
GOOGLE_SHEETS_KEY_FILE=./google-key.json

# Google OAuthï¼ˆä¿æŒåŸæœ‰ï¼‰
GOOGLE_CLIENT_ID=...
GOOGLE_CLIENT_SECRET=...
GOOGLE_REDIRECT_URI=...

# ç§»é™¤é€™äº› GAS ç›¸é—œçš„è®Šæ•¸ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
# GAS_WEBHOOK_URL=... ï¼ˆåˆªé™¤ï¼‰
# WEBHOOK_TOKEN=...   ï¼ˆåˆªé™¤ï¼‰
```

### 3.3 å®‰è£ä¾è³´

åŸ·è¡Œä»¥ä¸‹å‘½ä»¤ä»¥å®‰è£ Google Sheets API ä¾è³´ï¼š

```bash
npm install
```

---

## ç¬¬ 4 æ­¥ï¼šå…±äº«è©¦ç®—è¡¨çµ¦æœå‹™å¸³æˆ¶

1. æ‰“é–‹æ‚¨å»ºç«‹çš„ Google Sheets è©¦ç®—è¡¨
2. é»æ“Šå³ä¸Šè§’çš„ã€Œå…±äº«ã€æŒ‰éˆ•
3. åœ¨ Google Cloud Console çš„æœå‹™å¸³æˆ¶é é¢ä¸­æ‰¾åˆ°æ‚¨çš„æœå‹™å¸³æˆ¶é›»å­éƒµä»¶åœ°å€ï¼ˆæ ¼å¼å¦‚ `your-service-account@your-project.iam.gserviceaccount.com`ï¼‰
4. å°‡æ­¤é›»å­éƒµä»¶åœ°å€ç²˜è²¼åˆ° Google Sheets çš„å…±äº«è¦–çª—ä¸­
5. é¸æ“‡ã€Œç·¨è¼¯è€…ã€æ¬Šé™
6. é»æ“Šã€Œå…±äº«ã€

---

## ç¬¬ 5 æ­¥ï¼šåˆå§‹åŒ–è©¦ç®—è¡¨ï¼ˆå¯é¸ï¼‰

æ‚¨å¯ä»¥é€é Node.js å‘½ä»¤ç›´æ¥åˆå§‹åŒ–è©¦ç®—è¡¨ï¼ˆå»ºç«‹æ¨™é¡Œæ¬„ä½ï¼‰ï¼š

```javascript
// åœ¨æ‚¨çš„ç¨‹å¼ç¢¼ä¸­åŸ·è¡Œï¼š
import * as sheetsService from "./src/services/sheets.js";

await sheetsService.initializeSheet();
console.log("è©¦ç®—è¡¨åˆå§‹åŒ–æˆåŠŸï¼");
```

æˆ–è€…å»ºç«‹ä¸€å€‹ç°¡å–®çš„åˆå§‹åŒ–è…³æœ¬ï¼š

```javascript
// init-sheets.js
import dotenv from "dotenv";
import * as sheetsService from "./src/services/sheets.js";

dotenv.config();

(async () => {
  try {
    await sheetsService.initializeSheet();
    console.log("âœ… è©¦ç®—è¡¨åˆå§‹åŒ–æˆåŠŸï¼");
    process.exit(0);
  } catch (error) {
    console.error("âŒ åˆå§‹åŒ–å¤±æ•—:", error.message);
    process.exit(1);
  }
})();
```

åŸ·è¡Œï¼š
```bash
node init-sheets.js
```

---

## ç¬¬ 6 æ­¥ï¼šå•Ÿå‹•ä¼ºæœå™¨

ç¾åœ¨æ‚¨çš„å°ˆæ¡ˆå·²æº–å‚™å¥½ä½¿ç”¨ Google Sheets API ç›´æ¥æ“ä½œè©¦ç®—è¡¨ï¼š

```bash
npm start
```

---

## API åŠŸèƒ½ä»‹ç´¹

### `findPendingOrder(userEmail, productID)`
æŸ¥æ‰¾è©²ä½¿ç”¨è€…å°è©²å•†å“æ˜¯å¦æœ‰ç¾æœ‰çš„ã€Œå¾…æ”¯ä»˜ã€è¨‚å–®ï¼ˆç”¨æ–¼è¨‚å–®è¤‡ç”¨ï¼‰

```javascript
const order = await sheetsService.findPendingOrder("user@example.com", "prod_001");
if (order) {
  console.log("é‡ç”¨è¨‚å–®è™Ÿ:", order.tradeNo);
}
```

### `createOrder(orderData)`
å»ºç«‹æ–°è¨‚å–®

```javascript
await sheetsService.createOrder({
  tradeNo: "test1678886400",
  productID: "prod_001",
  productName: "ç¯„ä¾‹å•†å“",
  tradeAmt: 100,
  email: "user@example.com",
});
```

### `updateOrder(updateData)`
æ›´æ–°è¨‚å–®ç‹€æ…‹

```javascript
await sheetsService.updateOrder({
  MerTradeNo: "test1678886400",
  TradeSeq: "P2023031500001",
  Status: "å·²å®Œæˆ",
});
```

### `getUserOrders(userEmail)`
æŸ¥è©¢ç‰¹å®šä½¿ç”¨è€…çš„æ‰€æœ‰è¨‚å–®

```javascript
const orders = await sheetsService.getUserOrders("user@example.com");
console.log("ä½¿ç”¨è€…çš„æ‰€æœ‰è¨‚å–®:", orders);
```

### `initializeSheet()`
åˆå§‹åŒ–è©¦ç®—è¡¨ï¼ˆå»ºç«‹æ¨™é¡Œæ¬„ä½ï¼‰

```javascript
await sheetsService.initializeSheet();
```

---

## è©¦ç®—è¡¨æ¬„ä½èªªæ˜

åˆå§‹åŒ–å¾Œçš„è©¦ç®—è¡¨å°‡åŒ…å«ä»¥ä¸‹æ¬„ä½ï¼š

| æ¬„ä½ | èªªæ˜ |
|------|------|
| æ—¥æœŸ | è¨‚å–®å»ºç«‹çš„æ™‚é–“æˆ³ |
| è¨‚å–®è™Ÿ | äº¤æ˜“ç·¨è™Ÿ (MerTradeNo) |
| å•†å“ ID | å•†å“è­˜åˆ¥ç¢¼ |
| å•†å“åç¨± | å•†å“åç¨± |
| é‡‘é¡ | äº¤æ˜“é‡‘é¡ |
| Email | ä½¿ç”¨è€…é›»å­éƒµä»¶ |
| ç‹€æ…‹ | è¨‚å–®ç‹€æ…‹ï¼ˆå¾…æ”¯ä»˜ã€å·²å®Œæˆã€å·²é€€æ¬¾ç­‰ï¼‰ |
| äº¤æ˜“åºè™Ÿ | Payuni äº¤æ˜“åºè™Ÿ (TradeSeq) |
| æœ€å¾Œæ›´æ–° | ä¸Šæ¬¡æ›´æ–°æ™‚é–“ |
| åŸå§‹è³‡æ–™ | å®Œæ•´çš„ JSON è³‡æ–™ |

---

## æ•…éšœæ’é™¤

### âŒ ã€Œèªè­‰é‡‘é‘°æ–‡ä»¶æœªæ‰¾åˆ°ã€

**åŸå› **ï¼š`google-key.json` æ–‡ä»¶ä¸å­˜åœ¨æˆ–è·¯å¾‘éŒ¯èª¤

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
1. ç¢ºèª `google-key.json` ä½æ–¼å°ˆæ¡ˆæ ¹ç›®éŒ„
2. æª¢æŸ¥ `.env` ä¸­çš„ `GOOGLE_SHEETS_KEY_FILE` è·¯å¾‘æ˜¯å¦æ­£ç¢º
3. å¦‚æœä½¿ç”¨è‡ªè¨‚è·¯å¾‘ï¼Œç¢ºä¿ç’°å¢ƒè®Šæ•¸è¨­ç½®æ­£ç¢º

### âŒ ã€ŒPermission deniedã€

**åŸå› **ï¼šæœå‹™å¸³æˆ¶ç„¡æ¬Šå­˜å–è©¦ç®—è¡¨

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
1. ç¢ºèªå·²å°‡è©¦ç®—è¡¨å…±äº«çµ¦æœå‹™å¸³æˆ¶é›»å­éƒµä»¶
2. ç¢ºèªæ¬Šé™è¨­ç½®ç‚ºã€Œç·¨è¼¯è€…ã€
3. åœ¨ Google Cloud Console é©—è­‰æœå‹™å¸³æˆ¶æ˜¯å¦æ­£ç¢º

### âŒ ã€Œç¼ºå°‘ GOOGLE_SHEETS_ID ç’°å¢ƒè®Šæ•¸ã€

**åŸå› **ï¼šæœªè¨­ç½® `GOOGLE_SHEETS_ID` ç’°å¢ƒè®Šæ•¸

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
1. åœ¨ `.env` ä¸­æ·»åŠ  `GOOGLE_SHEETS_ID=<æ‚¨çš„_SHEET_ID>`
2. é‡æ–°å•Ÿå‹• Node.js ä¼ºæœå™¨

### âŒ ã€ŒGoogle Sheets API is not enabledã€

**åŸå› **ï¼šæœªåœ¨ Google Cloud ä¸­å•Ÿç”¨ API

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
1. å›åˆ° [Google Cloud Console](https://console.cloud.google.com/)
2. ç¢ºä¿é¸æ“‡äº†æ­£ç¢ºçš„å°ˆæ¡ˆ
3. é€²å…¥ã€ŒAPI å’Œæœå‹™ã€ >ã€ŒAPI åº«ã€
4. æœå°‹ã€ŒGoogle Sheets APIã€ä¸¦å•Ÿç”¨

---

## å®‰å…¨æç¤º

ğŸ”’ **é‡è¦å®‰å…¨å»ºè­°**ï¼š

1. **æ°¸é ä¸è¦å°‡ `google-key.json` æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶**ï¼ˆæ·»åŠ åˆ° `.gitignore`ï¼‰
2. **ä¸è¦åœ¨å‰ç«¯æš´éœ²æœå‹™å¸³æˆ¶é‡‘é‘°**
3. **å®šæœŸè¼ªæ›æœå‹™å¸³æˆ¶é‡‘é‘°**ï¼ˆåœ¨ Google Cloud Console ä¸­ï¼‰
4. **é™åˆ¶æœå‹™å¸³æˆ¶çš„æ¬Šé™**ï¼ˆåªçµ¦äºˆ Sheets API çš„å¿…è¦æ¬Šé™ï¼‰
5. **åœ¨ç”Ÿç”¢ç’°å¢ƒä¸­ä½¿ç”¨ç’°å¢ƒè®Šæ•¸**è€Œä¸æ˜¯ç¡¬ç·¨ç¢¼çš„å€¼

---

## é·ç§»å¾ GAS åˆ° Google Sheets API

å¦‚æœæ‚¨ä¹‹å‰ä½¿ç”¨äº† GAS Webhookï¼Œå¯ä»¥æŒ‰ç…§ä»¥ä¸‹æ­¥é©Ÿé·ç§»ï¼š

### èˆŠçš„ GAS ç’°å¢ƒè®Šæ•¸ï¼ˆåˆªé™¤ï¼‰
```env
GAS_WEBHOOK_URL=https://script.google.com/macros/s/...
WEBHOOK_TOKEN=...
```

### æ–°çš„ Google Sheets API ç’°å¢ƒè®Šæ•¸ï¼ˆæ·»åŠ ï¼‰
```env
GOOGLE_SHEETS_ID=æ‚¨çš„è©¦ç®—è¡¨ID
GOOGLE_SHEETS_KEY_FILE=./google-key.json
```

### ä»£ç¢¼è®Šæ›´
- `payment.js` ä¸­çš„ `findExistingOrder()` â†’ ä½¿ç”¨ `sheetsService.findPendingOrder()`
- `payment.js` ä¸­çš„ `createOrderInGAS()` â†’ ä½¿ç”¨ `sheetsService.createOrder()`
- `payment.js` ä¸­çš„ `updateOrderInGAS()` â†’ ä½¿ç”¨ `sheetsService.updateOrder()`
- `orders.js` ä¸­çš„ `/api/my-orders` â†’ ä½¿ç”¨ `sheetsService.getUserOrders()`

æ‰€æœ‰é€™äº›è®Šæ›´å·²è‡ªå‹•æ‡‰ç”¨æ–¼æ‚¨çš„å°ˆæ¡ˆï¼

---

## ä¸‹ä¸€æ­¥

âœ… å·²å®Œæˆçš„ï¼š
- âœ”ï¸ å®‰è£ä¾è³´
- âœ”ï¸ æ›´æ–° payment.js å’Œ orders.js
- âœ”ï¸ æ›´æ–°ç’°å¢ƒè®Šæ•¸é…ç½®

ğŸ“‹ æ‚¨éœ€è¦å®Œæˆçš„ï¼š
1. å»ºç«‹ Google Sheets è©¦ç®—è¡¨
2. å»ºç«‹ Google Cloud æœå‹™å¸³æˆ¶å’Œä¸‹è¼‰é‡‘é‘°
3. è¤‡è£½ `google-key.json` åˆ°å°ˆæ¡ˆæ ¹ç›®éŒ„
4. æ›´æ–° `.env` æ–‡ä»¶
5. å…±äº«è©¦ç®—è¡¨çµ¦æœå‹™å¸³æˆ¶
6. åŸ·è¡Œ `npm install` å®‰è£æ–°çš„ä¾è³´
7. ï¼ˆå¯é¸ï¼‰åŸ·è¡Œåˆå§‹åŒ–è…³æœ¬
8. é‡å•Ÿä¼ºæœå™¨

æœ‰ä»»ä½•å•é¡Œï¼Œè«‹åƒè€ƒä¸Šé¢çš„ã€Œæ•…éšœæ’é™¤ã€ç« ç¯€ã€‚

ç¥æ‚¨ä½¿ç”¨æ„‰å¿«ï¼ ğŸ‰
