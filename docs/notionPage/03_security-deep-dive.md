# 安全機制：防背鍋指南

> **資安不是為了過稽核，是為了保護你的週末。**
> 這份清單是你的「保險單」。只要這 5 層防線都開了，就算被攻擊，你也能在檢討會上大聲說：「我們該做的都做了。」

---

## 👔 給決策者的 30 秒懶人包

**如果您是老闆或 PM，請只讀這一段：**

1.  **我們做了什麼防護？** 我們像洋蔥一樣包了 5 層。就算駭客剝開第一層，還有四層在等他。
2.  **這些名詞是什麼意思？**
    *   **Helmet** = 防彈背心（擋掉 80% 無聊的攻擊）。
    *   **CORS** = 門禁卡（只有我們自己的網站能呼叫 API）。
    *   **CSRF** = 親筆簽名（防止別人冒充你下單）。
    *   **Session** = 識別證（防止別人偷走你的登入狀態）。
    *   **AES 加密** = 密碼鎖（資料傳輸過程全是亂碼）。
3.  **結論**：這套標準符合業界規範，能擋掉絕大多數常見攻擊。

---

## 📖 這一頁是什麼

這不是資安教科書，這是**「讓資安稽核閉嘴」**的實戰設定集。
我們採用「深度防禦 (Defense in Depth)」策略：就算駭客過了第一關，還有四關在等他。

**預期耗時：** 20 分鐘
**你將獲得：** 5 層防線設定 + 1 份「部署前檢查清單」

---

## 🔒 五層防禦深度解析

### 第 1 層：Helmet - 防止「低級錯誤」被抓包

> **一句話解釋：** 幫你自動加上 HTTP Header，擋掉 80% 的腳本小子攻擊。
> **📂 檔案位置：** `src/app.js` (搜尋 `helmet()`)

#### 💀 如果不設會怎樣？
- **XSS 攻擊**：駭客在你的網頁塞惡意腳本，偷走使用者的 Cookie。
- **點擊劫持**：駭客把你的網站用 `<iframe>` 包起來，騙使用者點擊。

#### ✅ 我們的設定 (已內建)
- `Strict-Transport-Security`：強制 HTTPS，不讓駭客降級攻擊。
- `X-Frame-Options: DENY`：禁止被嵌入 iframe，防止點擊劫持。
- `X-Content-Type-Options: nosniff`：防止瀏覽器亂猜檔案類型。

---

### 第 2 層：CORS - API 的私人保鑣

> **一句話解釋：** 只有「自己人」的前端，才能呼叫後端的 API。
> **📂 檔案位置：** `src/app.js` (搜尋 `cors()`)

#### 💀 如果不設會怎樣？
- 任何人的網站都可以用 AJAX 呼叫你的 API。
- 駭客可以在自己的網站上寫個腳本，幫你的使用者下單。

#### ✅ 我們的設定 (已內建)
在 `.env` 裡設定 `DOMAIN`，後端只接受來自這個 Domain 的請求。
```javascript
// ❌ 錯誤寫法 (自殺行為)
origin: '*' 

// ✅ 正確寫法 (只信自己)
origin: process.env.DOMAIN
```

---

### 第 3 層：CSRF - 確保是本人親自點擊

> **一句話解釋：** 每次下單都要附上「當次有效的簽名」，防止被釣魚網站代點。
> **📂 檔案位置：** `src/middleware/security.js` (搜尋 `csurf`)

#### 💀 如果不設會怎樣？
- 使用者登入了你的網站，然後去逛別的論壇。
- 論壇裡有一張圖片 `<img src="https://yoursite.com/api/buy?id=1">`。
- 瀏覽器會自動帶著 Cookie 發送請求，使用者就莫名其妙買了東西。

#### ✅ 我們的設定 (已內建)
- 使用 `csurf` 套件。
- 每次載入頁面產生一個 `csrfToken`。
- 前端 POST 時必須帶上這個 Token，否則後端直接拒絕。

---

### 第 4 層：Session - 保護通往金庫的鑰匙

> **一句話解釋：** 你的通行證 (Cookie) 必須是防盜、防窺、防偽造的。
> **📂 檔案位置：** `src/middleware/session.js`

#### 💀 如果不設會怎樣？
- **XSS 竊取**：駭客用 JS 讀取 `document.cookie`，直接拿走 Session ID。
- **中間人攻擊**：在公共 Wi-Fi 下，駭客攔截 HTTP 封包，看光你的 Cookie。

#### ✅ 我們的設定 (已內建)
```javascript
cookie: {
  httpOnly: true,    // ❌ JS 讀不到 (擋 XSS)
  secure: true,      // 🔒 只走 HTTPS (擋監聽)
  sameSite: 'strict' // 🚫 跨站不送 Cookie (擋 CSRF)
}
```

---

### 第 5 層：AES-256-GCM - 最後一道防線 (加密)

> **一句話解釋：** 就算資料被攔截，駭客看到的也只是一堆亂碼。
> **📂 檔案位置：** `src/utils/crypto.js`

#### 💀 如果不設會怎樣？
- 訂單資料在網路上裸奔。
- 駭客攔截 Webhook，把金額從 100 改成 1。

#### ✅ 我們的設定 (已內建)
- 使用 Payuni 指定的 AES-256-GCM 加密。
- **GCM 模式**自帶「身份驗證」，如果資料被改過，解密會直接失敗。
- 金鑰 (Key) 和向量 (IV) 藏在 `.env`，絕對不進 Git。

---

## ✅ 部署前「防背鍋」檢查清單 (Flight Check)

上線前，請務必對著這張表打勾。這張表是你睡好覺的保證。

- [ ] **HTTPS 強制開啟**：確認 `Strict-Transport-Security` 有生效，沒有人能用 HTTP 連進來。
- [ ] **CORS 白名單鎖死**：`.env` 裡的 `DOMAIN` 是不是只有你的前端網域？不要留 `*` 或 `localhost`。
- [ ] **Session Secret 足夠亂**：不要用 "keyboard cat"，去用密碼產生器生一串 64 字元的亂碼。
- [ ] **Cookie 屬性全開**：`httpOnly`, `secure`, `sameSite: strict` 缺一不可。
- [ ] **Webhook 驗證有開**：確認後端有驗證 Payuni 傳來的 Hash，而不是直接相信內容。
- [ ] **API Key 沒進 Git**：檢查 `.gitignore`，確認 `.env` 沒有被 commit 上去。

> **💡 想要一鍵檢查？**
> 我們準備了一個腳本，直接幫你跑這些檢查：
> ```bash
> node scripts/audit.js
> ```
> 如果看到綠色的 **SYSTEM READY FOR TAKEOFF**，你就可以安心上線了。

---

## 📚 下一步

裝備檢查完畢，安全防線已就位。
現在，你可以放心地去改這套系統，把它變成你自己的產品了。

👉 **[前往動手實踐：60 分鐘改出你的版本](/04_customization-guide)**
