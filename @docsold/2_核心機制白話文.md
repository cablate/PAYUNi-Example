# 核心機制白話文：金流系統是怎麼運作的？

這份文件將用最簡單的比喻，帶您理解金流系統中各個部分是如何分工合作的。想像一下，您的金流系統就像一家運作良好的商店。

---

## Part 1: 職責劃分：每個角色都不可或缺

### 1.1 前端 (瀏覽器)：您的「門市與接待員」

-   **職責**：當顧客走進您的網站（前端），他們看到的是漂亮的商品陳列（網頁介面）。前端就像是您的「門市與接待員」，負責：
    -   **展示商品**：讓顧客看到想買的東西。
    -   **與顧客互動**：讓顧客點擊、輸入 Email、選擇商品。
    -   **收集意向**：當顧客點擊「購買」時，前端會收集顧客的購買意向（想買什麼、Email 是什麼），並將這些資訊安全地傳遞給後台。
-   **它不應該**：接待員不應該知道金庫的密碼，也不應該決定商品的最終價格。它只負責收集資訊和引導顧客。

### 1.2 後端 (Node.js 伺服器)：您的「金庫與大腦」

-   **職責**：後端是您商店的「金庫與大腦」，它是整個系統最核心、最安全的部分。它負責：
    -   **安全檢查**：接待員傳來的資訊，它會先進行嚴格的安全檢查（例如：確認顧客不是機器人、請求不是來自惡意網站）。
    -   **身份驗證**：確認顧客是誰（透過 Google 登入）。
    -   **決策與協調**：根據顧客的購買意向，決定如何處理（例如：產生訂單號碼、加密交易資料），並協調其他部門（例如：通知 Google Sheets 記錄訂單、與 Payuni 溝通）。
    -   **保管秘密**：所有重要的金鑰、密碼都只存放在這裡，絕不讓前端知道。
-   **它是唯一能**：接觸金鑰、執行加密、確認交易、以及與外部金流服務溝通的核心。

### 1.3 資料庫 (Google Sheets/GAS)：您的「帳本」

-   **職責**：Google Sheets 就像是您商店的「帳本」。它的職責非常單純：
    -   **忠實記錄**：每一筆訂單的建立、狀態變更，都會被忠實地記錄在這裡。
    -   **簡單明瞭**：您可以非常直觀地查看所有訂單，就像看一份 Excel 表格一樣。
-   **它不應該**：帳本不應該負責複雜的計算或決策。它的職責越單純（只負責記錄），系統就越穩定。

### 1.4 金流閘道 (Payuni)：您的「銀行櫃員」

-   **職責**：Payuni 就像是您合作銀行的「銀行櫃員」。當您的「大腦」準備好交易資料後，會將顧客引導到 Payuni 的櫃檯：
    -   **處理金錢**：顧客在這裡輸入信用卡資訊，由 Payuni 負責處理實際的扣款。
    -   **安全隔離**：您的系統永遠不會接觸到顧客的信用卡號碼，所有敏感資訊都由 Payuni 直接處理，確保安全。
-   **您永遠不應該**：在您的系統中儲存任何信用卡號碼。

---

## Part 2: Webhook 機制深度解析：「銀行櫃員的回電」

Webhook 是金流串接中一個非常重要，但常常被誤解的概念。

### 2.1 本質：非同步的「回電」

-   **想像一下**：您去銀行辦理一筆大額轉帳。櫃員告訴您：「這筆轉帳需要一點時間處理，處理完後我會打電話通知您結果。」您不必在銀行乾等，可以先去忙別的事情。
-   **Webhook 就是這個「回電」**：當使用者在 Payuni 頁面完成付款後，Payuni 的「銀行櫃員」不會讓使用者在原地等待，而是會主動打電話（發送一個 POST 請求）到您預留的「電話號碼」（`NOTIFY_URL`），告訴您的「大腦」這筆交易的最終結果。

### 2.2 為何它是「唯一可信的真相來源」？

-   **使用者行為不可控**：使用者在 Payuni 付款頁面可能直接關閉瀏覽器、網路中斷、或手機沒電。這些情況都會導致使用者無法看到 Payuni 跳轉回您網站的「結果頁」。
-   **伺服器對伺服器**：Webhook 是 Payuni 的伺服器直接與您的後端伺服器溝通。這是一種「伺服器對伺服器」的通訊，不受使用者瀏覽器行為的影響，因此它是**最可靠、最準確的交易結果來源**。您判斷是否要出貨、提供服務的**最終依據，必須是 Webhook 的通知**。

### 2.3 安全核心：簽名驗證（「秘密握手」）

-   **誰都可以打電話，但只有 Payuni 知道「暗號」**：您的 Webhook URL 是一個公開的電話號碼，任何人都可以嘗試打電話過來。但為了確保這個「回電」真的是來自 Payuni，而不是惡意攻擊者偽造的，我們需要一個「秘密握手」。
-   **Hash 簽名就是「暗號」**：Payuni 在發送通知時，會附帶一個特殊的「暗號」（`HashInfo` 簽名）。您的後端在接到電話時，第一件事就是用同樣的規則，根據收到的資料，自己也計算一次「暗號」。
-   **比對暗號**：如果自己計算的「暗號」與 Payuni 傳來的「暗號」完全一致，那就證明這個電話確實是 Payuni 打來的，而且通話內容沒有被中途竄改。如果對不上，您的後端會立刻「掛斷電話」（拒絕處理），確保安全。

理解了這些核心機制，您就能更自信地管理您的金流系統，並在此基礎上進行各種創新。
